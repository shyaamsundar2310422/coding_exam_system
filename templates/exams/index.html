<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackerRank-Style Coding Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.2);
        }

        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .problems-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .problem-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .problem-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .problem-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .difficulty-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .difficulty-easy { background: #00B894; }
        .difficulty-medium { background: #FDCB6E; }
        .difficulty-hard { background: #E17055; }

        .problem-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .contest-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .contest-card:hover {
            transform: translateY(-2px);
        }

        .contest-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .contest-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .problem-solving {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .problem-description {
            margin-bottom: 2rem;
        }

        .problem-description h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .problem-description p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .code-editor {
            margin-bottom: 2rem;
        }

        .code-editor textarea {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .test-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .test-case {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .test-case.passed {
            border-left: 4px solid #27ae60;
        }

        .test-case.failed {
            border-left: 4px solid #e74c3c;
        }

        .test-case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .test-status {
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-passed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 1rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">CodeContest</div>
            <nav class="nav-menu">
                <a href="#problems">Problems</a>
                <a href="#contests">Contests</a>
                <a href="#leaderboard">Leaderboard</a>
                <a href="#profile">Profile</a>
            </nav>
        </div>
    </div>

    <div class="main-container">
        <!-- Dashboard Section -->
        <div class="dashboard">
            <div class="problems-section">
                <h2 class="section-title">Problems</h2>
                <div id="problemsList">
                    <div class="loading">Loading problems... Please wait while we load the problems.</div>
                </div>
            </div>

            <div class="sidebar">
                <h3 class="section-title">Active Contests</h3>
                <div id="contestsList">
                    <div class="loading">Loading contests...</div>
                </div>
            </div>
        </div>

        <!-- Problem Solving Section -->
        <div id="problemSolving" class="problem-solving hidden">
            <h2 class="section-title" id="currentProblemTitle">Problem Title</h2>
            
            <div class="problem-description" id="problemDescription">
                <!-- Problem description will be loaded here -->
            </div>

            <div class="code-editor">
                <h3>Your Code</h3>
                <textarea id="codeEditor" placeholder="Write your solution here..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn btn-warning" onclick="runCode()">Run Code</button>
                <button class="btn btn-success" onclick="submitCode()">Submit Solution</button>
                <button class="btn btn-primary" onclick="backToProblems()">Back to Problems</button>
            </div>

            <div id="testResults" class="test-results hidden">
                <h3>Test Results</h3>
                <div id="testResultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentProblem = null;
        let currentSession = null;
        let problems = [];
        let contests = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchProblems();
            fetchContests();
        });

        // Fetch problems from the API
        async function fetchProblems() {
            try {
                const response = await fetch('/api/problems/');
                if (response.ok) {
                    problems = await response.json();
                    displayProblems(problems);
                } else {
                    console.error('Failed to fetch problems:', response.status);
                    document.getElementById('problemsList').innerHTML = 
                        '<div class="error">Failed to load problems. Please try again later.</div>';
                }
            } catch (error) {
                console.error('Error fetching problems:', error);
                document.getElementById('problemsList').innerHTML = 
                    '<div class="error">Error loading problems. Please check your connection.</div>';
            }
        }

        // Display problems in the UI
        function displayProblems(problemsList) {
            const problemsContainer = document.getElementById('problemsList');
            
            if (problemsList.length === 0) {
                problemsContainer.innerHTML = '<div class="loading">No problems available.</div>';
                return;
            }

            const problemsHTML = problemsList.map(problem => `
                <div class="problem-card" onclick="selectProblem(${problem.id})">
                    <div class="problem-header">
                        <div class="problem-title">${problem.title}</div>
                        <div class="difficulty-badge difficulty-${problem.category?.name?.toLowerCase() || 'medium'}">
                            ${problem.category?.name || 'Medium'}
                        </div>
                    </div>
                    <div class="problem-stats">
                        <span>Points: ${problem.points}</span>
                        <span>Difficulty: ${problem.difficulty_score}/10</span>
                        <span>Acceptance: ${problem.acceptance_rate?.toFixed(1) || 0}%</span>
                    </div>
                </div>
            `).join('');

            problemsContainer.innerHTML = problemsHTML;
        }

        // Fetch contests from the API
        async function fetchContests() {
            try {
                const response = await fetch('/api/contests/');
                if (response.ok) {
                    contests = await response.json();
                    displayContests(contests);
                } else {
                    console.error('Failed to fetch contests:', response.status);
                    document.getElementById('contestsList').innerHTML = 
                        '<div class="error">Failed to load contests.</div>';
                }
            } catch (error) {
                console.error('Error fetching contests:', error);
                document.getElementById('contestsList').innerHTML = 
                    '<div class="error">Error loading contests.</div>';
            }
        }

        // Display contests in the sidebar
        function displayContests(contestsList) {
            const contestsContainer = document.getElementById('contestsList');
            
            if (contestsList.length === 0) {
                contestsContainer.innerHTML = '<div class="loading">No contests available.</div>';
                return;
            }

            const contestsHTML = contestsList.map(contest => `
                <div class="contest-card" onclick="viewContest(${contest.id})">
                    <div class="contest-title">${contest.title}</div>
                    <div class="contest-info">
                        <div>Type: ${contest.contest_type_display}</div>
                        <div>Status: ${contest.status_display}</div>
                        <div>Duration: ${contest.duration} min</div>
                        <div>Participants: ${contest.current_participants_count}/${contest.max_participants}</div>
                    </div>
                </div>
            `).join('');

            contestsContainer.innerHTML = contestsHTML;
        }

        // Select a problem to solve
        async function selectProblem(problemId) {
            try {
                const response = await fetch(`/api/problems/${problemId}/start_exam/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const sessionData = await response.json();
                    currentSession = sessionData;
                    currentProblem = problems.find(p => p.id === problemId);
                    
                    console.log('Session started:', sessionData);
                    console.log('Current problem:', currentProblem);
                    
                    startExamSession(sessionData);
                } else {
                    console.error('Failed to start exam session:', response.status);
                }
            } catch (error) {
                console.error('Error starting exam session:', error);
            }
        }

        // Start exam session
        function startExamSession(sessionData) {
            // Hide problems section
            document.querySelector('.dashboard').classList.add('hidden');
            
            // Show problem solving section
            document.getElementById('problemSolving').classList.remove('hidden');
            
            // Set problem title
            document.getElementById('currentProblemTitle').textContent = currentProblem.title;
            
            // Set initial code
            document.getElementById('codeEditor').value = currentProblem.initial_code;
            
            // Display problem description
            const descriptionHTML = `
                <h3>Problem Description</h3>
                <p>${currentProblem.problem_statement}</p>
                
                <h3>Input Format</h3>
                <p>${currentProblem.input_format}</p>
                
                <h3>Output Format</h3>
                <p>${currentProblem.output_format}</p>
                
                <h3>Constraints</h3>
                <p>${currentProblem.constraints}</p>
                
                <h3>Sample Input</h3>
                <pre>${currentProblem.sample_input}</pre>
                
                <h3>Sample Output</h3>
                <pre>${currentProblem.sample_output}</pre>
                
                ${currentProblem.explanation ? `<h3>Explanation</h3><p>${currentProblem.explanation}</p>` : ''}
            `;
            
            document.getElementById('problemDescription').innerHTML = descriptionHTML;
        }

        // Run code to test it
        async function runCode() {
            const code = document.getElementById('codeEditor').value;
            const language = 'javascript'; // Default to JavaScript for now
            
            if (!code.trim()) {
                alert('Please write some code first!');
                return;
            }

            try {
                const response = await fetch('/api/execute/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        language: language,
                        test_cases: currentProblem.test_cases.filter(tc => tc.is_sample)
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayTestResults(result.results, true);
                } else {
                    console.error('Failed to run code:', response.status);
                }
            } catch (error) {
                console.error('Error running code:', error);
            }
        }

        // Submit code for evaluation
        async function submitCode() {
            if (!currentSession) {
                console.error('No active session');
                return;
            }

            const code = document.getElementById('codeEditor').value;
            const language = 'javascript';

            if (!code.trim()) {
                alert('Please write some code first!');
                return;
            }

            // Debug logging
            console.log('Current session:', currentSession);
            console.log('Session ID:', currentSession.session_id);
            console.log('Session structure:', JSON.stringify(currentSession, null, 2));

            try {
                // Get the correct session ID - it might be nested
                const sessionId = currentSession.session_id || currentSession.id || currentSession.sessionId;
                console.log('Using session ID:', sessionId);
                
                if (!sessionId) {
                    console.error('No valid session ID found');
                    return;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/submit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        language: language
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayTestResults(result.test_results, false);
                    showSuccess('Solution submitted successfully!');
                } else {
                    const errorText = await response.text();
                    console.error('Failed to submit code. Status:', response.status);
                    console.error('Error response:', errorText);
                    showError('Failed to submit solution. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting code:', error);
                showError('Error submitting solution. Please check your connection.');
            }
        }

        // Display test results
        function displayTestResults(results, isRun) {
            const resultsContainer = document.getElementById('testResultsContent');
            const resultsSection = document.getElementById('testResults');
            
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<div class="loading">No test results available.</div>';
                resultsSection.classList.remove('hidden');
                return;
            }

            const resultsHTML = results.map(result => `
                <div class="test-case ${result.passed ? 'passed' : 'failed'}">
                    <div class="test-case-header">
                        <span class="test-status ${result.passed ? 'status-passed' : 'status-failed'}">
                            ${result.passed ? 'PASSED' : 'FAILED'}
                        </span>
                        <span>${result.name}</span>
                    </div>
                    <div>
                        <strong>Input:</strong> ${JSON.stringify(result.input)}<br>
                        <strong>Expected:</strong> ${JSON.stringify(result.expected)}<br>
                        <strong>Actual:</strong> ${JSON.stringify(result.actual)}<br>
                        ${result.error ? `<strong>Error:</strong> ${result.error}` : ''}
                    </div>
                </div>
            `).join('');

            resultsContainer.innerHTML = resultsHTML;
            resultsSection.classList.remove('hidden');
        }

        // Go back to problems list
        function backToProblems() {
            document.getElementById('problemSolving').classList.add('hidden');
            document.querySelector('.dashboard').classList.remove('hidden');
            document.getElementById('testResults').classList.add('hidden');
            
            currentProblem = null;
            currentSession = null;
        }

        // View contest details
        function viewContest(contestId) {
            // This would navigate to a contest-specific page
            alert(`Viewing contest ${contestId}. This feature is coming soon!`);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.getElementById('problemSolving');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.getElementById('problemSolving');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }
    </script>
</body>
</html> 